import{r as i,o as pe,c as fe,B as O,b as s,m as k,f as c,e as l,h as m,l as p,k as F,g as f,G as W,v as M,a as o,F as B,C as P,t as d,D as j,T as H,H as be,w as _e,j as Q,S as G,A as L}from"./index.BOknro1r.js";import{_ as ge,S as ye,v as he,p as xe,q as we,r as ke,o as J,g as Ce,s as Se}from"./SectionMain.B3hG14Sc.js";import{_ as De}from"./SectionTitleLineWithButton.C7bxM_9h.js";import{B as Me}from"./BaseTable.Ckuo5fbK.js";import{_ as b}from"./BaseButton.w6EMXcGq.js";import{_ as Ue}from"./NotificationBar.CM5Y_e5H.js";import{_ as $e}from"./Badge.D_Oe_-0y.js";import{T as Ae}from"./ToasterComponent.Dz5A3hFA.js";import{u as Te}from"./department.CLvmAIIQ.js";import{_ as Ve}from"./_plugin-vue_export-helper.DlAUqK2U.js";import"./BaseIcon.D7Rla7cl.js";const Re={class:"mb-4 grid grid-cols-1 sm:grid-cols-3 gap-2"},Be=["value"],je={class:"flex items-center justify-between mb-2"},Ie={class:"text-sm text-gray-500"},Ee={class:"flex gap-2"},Ne={class:"flex gap-2 justify-end"},Oe={key:0,class:"fixed inset-0 z-50 flex items-center justify-center"},Fe={class:"relative bg-white rounded-lg shadow-xl w-full max-w-lg p-5"},Pe={class:"text-lg font-semibold mb-3"},Le={class:"space-y-3"},ze={key:0,class:"text-red-600 text-xs mt-1"},Ke={key:0,class:"text-red-600 text-xs mt-1"},qe={class:"flex items-center gap-2"},We={class:"mt-5 flex justify-end gap-2"},He={key:0,class:"fixed inset-0 z-50 flex items-center justify-center"},Qe={class:"relative bg-white rounded-lg shadow-xl w-full max-w-5xl p-5"},Ge={class:"flex items-center justify-between mb-3"},Je={class:"text-lg font-semibold"},Xe={class:"grid grid-cols-1 md:grid-cols-3 gap-2 mb-3"},Ye={class:"md:col-span-2 relative"},Ze={key:1,class:"absolute z-10 mt-1 w-full bg-white border rounded shadow max-h-64 overflow-auto"},et={key:0,class:"p-2 text-sm text-gray-500"},tt=["onMousedown"],at=["src"],lt={key:1,class:"w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 text-xs"},st={class:"font-medium"},ot={class:"text-gray-500"},nt={key:0,class:"p-2 text-sm text-gray-500"},it={class:"md:col-span-1"},rt={class:"md:col-span-3 text-red-600 text-xs"},dt={key:0},ut={key:1},ct={class:"md:col-span-3 flex justify-end"},vt={class:"border rounded"},mt={class:"w-full text-sm"},pt={key:0},ft={class:"p-2"},bt={class:"p-2"},_t={class:"p-2"},gt=["onUpdate:modelValue","onChange","disabled"],yt={class:"p-2"},ht=["onUpdate:modelValue","onChange","disabled"],xt={class:"p-2"},wt={class:"p-2 text-right"},kt={key:0,class:"text-xs text-gray-500"},Ct={key:1},St={__name:"DepartmentManagementPage",setup(Dt){const r=Te(),U=i(null),h=i({page:1,limit:10,code:"",name:"",is_active:""}),X=[{label:"All",value:""},{label:"Active",value:"true"},{label:"Inactive",value:"false"}],w=async(a={},t=!0)=>{h.value={...h.value,...a};const e={...h.value};["code","name","is_active"].forEach(n=>{(e[n]===""||e[n]==null)&&delete e[n]}),await r.fetchAll(e,t)};pe(async()=>{await w({page:1,limit:10},!0)});const z=fe(()=>({total:r.departments.total||0,totalPages:r.departments.totalPages||1,currentPage:r.departments.currentPage||1,pageSize:r.departments.pageSize||10,data:r.departments.data||[]})),Y=[{key:"code",label:"Code",sortable:!0,minWidth:120},{key:"name",label:"Name",sortable:!0,minWidth:180},{key:"description",label:"Description",sortable:!1,minWidth:260},{key:"is_active",label:"Active",sortable:!0,width:100},{key:"actions",label:"",isAction:!0,width:60}],D=i(!1),$=i("create"),u=i({id:null,code:"",name:"",description:"",is_active:!0}),C=i({}),Z=()=>{$.value="create",u.value={id:null,code:"",name:"",description:"",is_active:!0},C.value={},D.value=!0},ee=async a=>{await r.fetchById(a.id);const t=r.selectedDepartment||a;$.value="edit",u.value={id:t.id,code:t.code||"",name:t.name||"",description:t.description||"",is_active:!!t.is_active},C.value={},D.value=!0},te=()=>{const a={};return u.value.code?.trim()||(a.code="Code is required"),u.value.name?.trim()||(a.name="Name is required"),C.value=a,Object.keys(a).length===0},ae=async()=>{if(!te())return;const a={code:u.value.code.trim(),name:u.value.name.trim(),description:(u.value.description||"").trim()||null,is_active:!!u.value.is_active};$.value==="create"?await r.create(a):await r.updateById(u.value.id,a),D.value=!1,await w({},!0)},le=async a=>{!a?.id||!(await G.fire({title:`Delete ${a.name}?`,text:"This action cannot be undone.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Delete"})).isConfirmed||(await r.deleteById(a.id),await w({},!0),await G.fire("Deleted","Department removed.","success"))},T=i(!1),_=i(null),V=i([]),R=i(!1),se=async a=>{_.value=a,T.value=!0,await K(a.id)},K=async a=>{try{R.value=!0;const t=await r.fetchMembers(a,!0),e=Array.isArray(t)?t:[];V.value=e.map(n=>({...n,_editRole:n?.membership?.role||"member",_editStatus:n?.membership?.status||"active",_saving:!1}))}catch{V.value=[]}finally{R.value=!1}},g=i({user_id:"",role:"member"}),A=i({}),S=i(""),I=i(!1),v=i([]),x=i(!1),E=i(null),N=i(null),y=i(-1),oe=async a=>{if(!a||a.length<2){v.value=[],x.value=!1,y.value=-1;return}try{I.value=!0;const{data:t}=await L.list({page:1,limit:8,username:a});v.value=Array.isArray(t)?t:[],x.value=v.value.length>0,y.value=v.value.length?0:-1}catch{v.value=[]}finally{I.value=!1}},ne=()=>{N.value=null,g.value.user_id="",E.value&&clearTimeout(E.value),E.value=setTimeout(()=>oe(S.value.trim()),250)},ie=()=>{v.value.length&&(x.value=!0)},re=()=>{setTimeout(()=>{x.value=!1},120)},de=a=>{!x.value&&(a.key==="ArrowDown"||a.key==="ArrowUp")&&v.value.length&&(x.value=!0),v.value.length&&(a.key==="ArrowDown"?(a.preventDefault(),y.value=(y.value+1)%v.value.length):a.key==="ArrowUp"?(a.preventDefault(),y.value=(y.value-1+v.value.length)%v.value.length):a.key==="Enter"?y.value>=0&&y.value<v.value.length&&(a.preventDefault(),q(v.value[y.value])):a.key==="Escape"&&(x.value=!1))},q=a=>{N.value=a,g.value.user_id=a.id,S.value=`@${a.username} - ${a.first_name||""} ${a.last_name||""}`.trim(),x.value=!1},ue=()=>{N.value=null,g.value.user_id="",S.value="",v.value=[]},ce=async()=>{const a={};String(g.value.user_id).trim()||(a.user_id="Select a user"),g.value.role?.trim()||(a.role="Role is required"),A.value=a,!Object.keys(a).length&&(await r.addMember(_.value.id,{user_id:Number(g.value.user_id),role:g.value.role.trim()}),g.value={user_id:"",role:"member"},S.value="",await K(_.value.id))},ve=async a=>{if(!_.value?.id||!a?.id)return;const t=a.membership?.role;a._saving=!0;try{await r.updateMember(_.value.id,a.id,{role:a._editRole});const e=await L.getDepartmentInfo(a.id,_.value.id);e?.membership&&(a.membership=e.membership,a._editRole=e.membership.role||a._editRole,a._editStatus=e.membership.status||a._editStatus),U?.value?.showToast("success",`Role updated to ${a._editRole}`)}catch{a._editRole=t||"member",U?.value?.showToast("error","Failed to update role")}finally{a._saving=!1}},me=async a=>{if(!_.value?.id||!a?.id)return;const t=a.membership?.status;a._saving=!0;try{await r.updateMember(_.value.id,a.id,{status:a._editStatus});const e=await L.getDepartmentInfo(a.id,_.value.id);e?.membership&&(a.membership=e.membership,a._editRole=e.membership.role||a._editRole,a._editStatus=e.membership.status||a._editStatus),U?.value?.showToast("success",`Status updated to ${a._editStatus}`)}catch{a._editStatus=t||"active",U?.value?.showToast("error","Failed to update status")}finally{a._saving=!1}};return(a,t)=>(s(),O(ge,null,{default:k(()=>[c(ye,null,{default:k(()=>[c(Ae,{ref_key:"toaster",ref:U},null,512),c(De,{icon:p(he),title:"Department Management",main:""},{default:k(()=>[...t[17]||(t[17]=[F(" Manage departments and memberships ",-1)])]),_:1},8,["icon"]),l("div",Re,[f(l("input",{"onUpdate:modelValue":t[0]||(t[0]=e=>h.value.code=e),class:"border p-2 rounded",placeholder:"Filter by code",onKeyup:t[1]||(t[1]=W(e=>w({page:1}),["enter"]))},null,544),[[M,h.value.code]]),f(l("input",{"onUpdate:modelValue":t[2]||(t[2]=e=>h.value.name=e),class:"border p-2 rounded",placeholder:"Filter by name",onKeyup:t[3]||(t[3]=W(e=>w({page:1}),["enter"]))},null,544),[[M,h.value.name]]),f(l("select",{"onUpdate:modelValue":t[4]||(t[4]=e=>h.value.is_active=e),class:"border p-2 rounded",onChange:t[5]||(t[5]=e=>w({page:1}))},[(s(),o(B,null,P(X,e=>l("option",{key:e.value,value:e.value},d(e.label),9,Be)),64))],544),[[j,h.value.is_active]])]),l("div",je,[l("div",Ie,[t[18]||(t[18]=F("Total: ",-1)),l("b",null,d(z.value.total),1)]),l("div",Ee,[c(b,{icon:p(xe),color:"info",label:"Refresh",onClick:t[6]||(t[6]=e=>w({},!0))},null,8,["icon"]),c(b,{icon:p(we),color:"primary",label:"Create",onClick:Z},null,8,["icon"])])]),c(Me,{columns:Y,data:z.value,loading:p(r).isLoading,showAction:!1,onQueryChange:w},{"cell-is_active":k(({value:e})=>[c($e,{text:e?"Active":"Inactive",tone:e?"emerald":"gray"},null,8,["text","tone"])]),"cell-actions":k(({row:e})=>[l("div",Ne,[c(b,{icon:p(ke),color:"primary",small:"",label:"View",to:{name:"department-view",params:{id:e.id}}},null,8,["icon","to"]),c(b,{icon:p(J),color:"primary",small:"",label:"Members",onClick:n=>se(e)},null,8,["icon","onClick"]),c(b,{icon:p(Ce),color:"primary",small:"",label:"Edit",onClick:n=>ee(e)},null,8,["icon","onClick"]),c(b,{icon:p(Se),color:"danger",small:"",label:"Delete",onClick:n=>le(e)},null,8,["icon","onClick"])])]),_:1},8,["data","loading"]),p(r).error?(s(),O(Ue,{key:0,color:"danger",class:"mt-4"},{default:k(()=>[F(d(p(r).error),1)]),_:1})):m("",!0),c(H,{name:"fade"},{default:k(()=>[D.value?(s(),o("div",Oe,[l("div",{class:"absolute inset-0 bg-black/50",onClick:t[7]||(t[7]=e=>D.value=!1)}),l("div",Fe,[l("h3",Pe,d($.value==="create"?"Create Department":"Edit Department"),1),l("div",Le,[l("div",null,[t[19]||(t[19]=l("label",{class:"block text-sm mb-1"},"Code",-1)),f(l("input",{"onUpdate:modelValue":t[8]||(t[8]=e=>u.value.code=e),class:"w-full border p-2 rounded",placeholder:"e.g., IT"},null,512),[[M,u.value.code]]),C.value.code?(s(),o("p",ze,d(C.value.code),1)):m("",!0)]),l("div",null,[t[20]||(t[20]=l("label",{class:"block text-sm mb-1"},"Name",-1)),f(l("input",{"onUpdate:modelValue":t[9]||(t[9]=e=>u.value.name=e),class:"w-full border p-2 rounded",placeholder:"e.g., Information Technology"},null,512),[[M,u.value.name]]),C.value.name?(s(),o("p",Ke,d(C.value.name),1)):m("",!0)]),l("div",null,[t[21]||(t[21]=l("label",{class:"block text-sm mb-1"},"Description",-1)),f(l("textarea",{"onUpdate:modelValue":t[10]||(t[10]=e=>u.value.description=e),class:"w-full border p-2 rounded",rows:"3",placeholder:"Optional description"},null,512),[[M,u.value.description]])]),l("div",qe,[f(l("input",{id:"dep-active",type:"checkbox","onUpdate:modelValue":t[11]||(t[11]=e=>u.value.is_active=e)},null,512),[[be,u.value.is_active]]),t[22]||(t[22]=l("label",{for:"dep-active",class:"text-sm"},"Active",-1))])]),l("div",We,[c(b,{label:"Cancel",color:"secondary",outline:"",onClick:t[12]||(t[12]=e=>D.value=!1)}),c(b,{label:$.value==="create"?"Create":"Update",color:"primary",onClick:ae},null,8,["label"])])])])):m("",!0)]),_:1}),c(H,{name:"fade"},{default:k(()=>[T.value?(s(),o("div",He,[l("div",{class:"absolute inset-0 bg-black/50",onClick:t[13]||(t[13]=e=>T.value=!1)}),l("div",Qe,[l("div",Ge,[l("h3",Je,"Members - "+d(_.value?.name||""),1),c(b,{label:"Close",color:"secondary",outline:"",small:"",onClick:t[14]||(t[14]=e=>T.value=!1)})]),l("div",Xe,[l("div",Ye,[t[23]||(t[23]=l("label",{class:"block text-sm mb-1"},"User",-1)),f(l("input",{"onUpdate:modelValue":t[15]||(t[15]=e=>S.value=e),onInput:ne,onFocus:ie,onBlur:re,onKeydown:de,class:"w-full border p-2 rounded",placeholder:"Search by username or email"},null,544),[[M,S.value]]),S.value?(s(),o("button",{key:0,onClick:ue,type:"button",class:"absolute right-2 top-8 text-sm text-gray-400 hover:text-gray-700"},"x")):m("",!0),x.value?(s(),o("div",Ze,[I.value?(s(),o("div",et,"Searching...")):(s(),o(B,{key:1},[(s(!0),o(B,null,P(v.value,(e,n)=>(s(),o("div",{key:e.id,class:Q(["flex items-center gap-2 p-2 text-sm cursor-pointer",n===y.value?"bg-blue-50":"hover:bg-gray-50"]),onMousedown:_e(Mt=>q(e),["prevent"])},[e.avatar?(s(),o("img",{key:0,src:e.avatar,alt:"avatar",class:"w-8 h-8 rounded-full object-cover"},null,8,at)):(s(),o("div",lt,d((e.username||"?").charAt(0).toUpperCase()),1)),l("div",null,[l("div",st,"@"+d(e.username),1),l("div",ot,d(e.first_name||"")+" "+d(e.last_name||"")+" - "+d(e.email),1)])],42,tt))),128)),v.value.length?m("",!0):(s(),o("div",nt,"No results"))],64))])):m("",!0)]),l("div",it,[t[25]||(t[25]=l("label",{class:"block text-sm mb-1"},"Role",-1)),f(l("select",{"onUpdate:modelValue":t[16]||(t[16]=e=>g.value.role=e),class:"w-full border p-2 rounded"},[...t[24]||(t[24]=[l("option",{value:"supervisor"},"supervisor",-1),l("option",{value:"member"},"member",-1)])],512),[[j,g.value.role]])]),l("div",rt,[A.value.user_id?(s(),o("span",dt,d(A.value.user_id)+" ",1)):m("",!0),A.value.role?(s(),o("span",ut,d(A.value.role),1)):m("",!0)]),l("div",ct,[c(b,{icon:p(J),color:"primary",label:"Add Member",onClick:ce},null,8,["icon"])])]),l("div",vt,[l("table",mt,[t[30]||(t[30]=l("thead",null,[l("tr",{class:"bg-gray-50 text-gray-600"},[l("th",{class:"text-left p-2"},"User"),l("th",{class:"text-left p-2"},"Email"),l("th",{class:"text-left p-2"},"Role"),l("th",{class:"text-left p-2"},"Status"),l("th",{class:"text-left p-2"},"Joined"),l("th",{class:"text-right p-2"},"Actions")])],-1)),l("tbody",null,[R.value?(s(),o("tr",pt,[...t[26]||(t[26]=[l("td",{colspan:"6",class:"p-3 text-center text-gray-500"},"Loading...",-1)])])):m("",!0),(s(!0),o(B,null,P(V.value,e=>(s(),o("tr",{key:e.id,class:Q(["border-t",e._saving?"opacity-60":""])},[l("td",ft,"@"+d(e.username)+" - "+d((e.first_name||"")+" "+(e.last_name||"")),1),l("td",bt,d(e.email),1),l("td",_t,[f(l("select",{class:"border p-1 rounded text-sm","onUpdate:modelValue":n=>e._editRole=n,onChange:n=>ve(e),disabled:e._saving},[...t[27]||(t[27]=[l("option",{value:"supervisor"},"supervisor",-1),l("option",{value:"member"},"member",-1)])],40,gt),[[j,e._editRole]])]),l("td",yt,[f(l("select",{class:"border p-1 rounded text-sm","onUpdate:modelValue":n=>e._editStatus=n,onChange:n=>me(e),disabled:e._saving},[...t[28]||(t[28]=[l("option",{value:"active"},"active",-1),l("option",{value:"inactive"},"inactive",-1)])],40,ht),[[j,e._editStatus]])]),l("td",xt,d(e.membership?.joined_at?new Date(e.membership.joined_at).toLocaleDateString():"-"),1),l("td",wt,[e._saving?(s(),o("span",kt,"Saving…")):(s(),O(b,{key:1,small:"",color:"danger",label:"Remove",class:"ml-2",onClick:n=>a.onRemoveMember(e)},null,8,["onClick"]))])],2))),128)),!R.value&&!V.value.length?(s(),o("tr",Ct,[...t[29]||(t[29]=[l("td",{colspan:"6",class:"p-3 text-center text-gray-500"},"No members yet.",-1)])])):m("",!0)])])])])])):m("",!0)]),_:1})]),_:1})]),_:1}))}},Ot=Ve(St,[["__scopeId","data-v-be57654b"]]);export{Ot as default};

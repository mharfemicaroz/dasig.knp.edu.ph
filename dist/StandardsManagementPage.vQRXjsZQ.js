import{u as ae,c as f,r as A,o as se,A as re,z as L,B as x,b as l,m as u,f as k,h as c,e as a,k as g,l as v,t as d,g as w,v as P,a as i,F as h,C as S,D as M,j as N,T as le,S as z}from"./index.BOknro1r.js";import{_ as ie,S as ne,b as oe,q as de,p as ue,g as ce,s as pe}from"./SectionMain.B3hG14Sc.js";import{_ as me}from"./SectionTitleLineWithButton.C7bxM_9h.js";import{B as ve}from"./BaseTable.Ckuo5fbK.js";import{_ as B}from"./BaseButton.w6EMXcGq.js";import{_ as $}from"./NotificationBar.CM5Y_e5H.js";import{u as fe}from"./standard.kVVUINdg.js";import{u as ge}from"./department.CLvmAIIQ.js";import{_ as _e}from"./_plugin-vue_export-helper.DlAUqK2U.js";import"./BaseIcon.D7Rla7cl.js";import"./ToasterComponent.Dz5A3hFA.js";const be={class:"mb-3 flex items-center justify-between"},ye={class:"flex items-center gap-2"},xe={class:"flex items-center gap-2"},ke={class:"rounded-2xl border bg-white shadow-sm mb-3 p-4"},we={class:"grid grid-cols-1 md:grid-cols-4 gap-3"},he={id:"areas"},Se=["value"],Ce={key:0,value:""},De=["value"],Ae=["value"],Ne={class:"text-sm text-gray-900"},Be={class:"inline-flex items-center rounded-full bg-gray-50 px-2 py-[2px] text-[11px] text-gray-700 ring-1 ring-gray-200"},Te={class:"inline-flex items-center rounded-full bg-indigo-50 px-2 py-[2px] text-[11px] text-indigo-700 ring-1 ring-indigo-200"},Ue={class:"text-sm text-gray-900"},Ve={class:"flex justify-end gap-1"},Pe={key:0,class:"fixed inset-0 bg-black/30 z-50 grid place-items-center"},Ee={class:"bg-white rounded-2xl shadow-xl w-full max-w-2xl"},Ie={class:"px-4 sm:px-6 py-3 border-b flex items-center justify-between"},Le={class:"text-lg font-semibold"},Me={class:"p-4 sm:p-6 space-y-3"},$e={key:0},Re=["value"],je=["value"],Ge={key:0,class:"text-xs text-red-600"},ze={key:0,class:"text-xs text-red-600"},qe={class:"grid grid-cols-1 md:grid-cols-3 gap-3"},Fe={id:"areas-edit"},Oe=["value"],Qe=["value"],We={class:"flex items-center gap-2 mt-6"},Ye={class:"flex items-center gap-3"},He={class:"inline-flex items-center gap-2 cursor-pointer"},Je=["checked"],Ke={class:"inline-flex items-center gap-2 cursor-pointer"},Xe=["checked"],Ze={class:"pt-2 flex justify-end"},et={key:1,class:"text-xs text-amber-600"},tt={__name:"StandardsManagementPage",setup(at){const o=fe(),C=ge(),E=ae(),p=f(()=>String(E.user?.role||"").toLowerCase()==="admin"),D=A([]),q=f(()=>Number(n.value.department_id||0)||null),F=f(()=>{const s=(D.value||[]).find(t=>Number(t.id)===q.value);return String(s?.membership?.role||s?.UserDepartment?.role||s?.user_department?.role||"").toLowerCase()}),R=f(()=>p.value?"admin":F.value==="supervisor"?"supervisor":"member"),I=["Governance","Records","Processes","Quality","Resources"],O=[{label:"core",value:"core"},{label:"core function",value:"core function"},{label:"extra",value:"extra"}],n=A({page:1,limit:10,description:"",area:"",department_id:""}),_=async(s={},t=!0)=>{n.value={...n.value,...s};const e={...n.value};if(["description","area","department_id"].forEach(m=>{(e[m]===""||e[m]==null)&&delete e[m]}),!p.value){const m=(D.value||[]).filter(U=>String(U?.membership?.role||U?.UserDepartment?.role||U?.user_department?.role||"").toLowerCase()==="supervisor").map(U=>Number(U.id)).filter(Boolean);m.length?(e.department_id&&!m.includes(Number(e.department_id))&&(e.department_id=m[0]),e.department_id||(e.department_id=m[0])):e.department_id=-1}await o.fetchAll(e,t)};se(async()=>{if(await C.fetchAll({page:1,limit:100},!0),!p.value&&E.user?.id)try{D.value=await re.getDepartments(E.user.id)}catch{}if(p.value){if(!n.value.department_id){const s=C.departments?.data?.[0];s?.id&&(n.value.department_id=Number(s.id))}}else{const s=V.value?.[0];s?.id&&(n.value.department_id=Number(s.id))}await _({page:1,limit:10},!0)}),L(()=>n.value.description,async()=>{await _({page:1},!0)}),L(()=>n.value.area,async()=>{await _({page:1},!0)}),L(()=>n.value.department_id,async()=>{await _({page:1},!0)});const Q=f(()=>({total:o.list.total||0,totalPages:o.list.totalPages||1,currentPage:o.list.currentPage||1,pageSize:o.list.pageSize||10,data:Array.isArray(o.list.data)?o.list.data:[]})),W=f(()=>{const s=new Map;return(D.value||[]).forEach(t=>{const e=String(t?.membership?.role||t?.UserDepartment?.role||t?.user_department?.role||"").toLowerCase();t?.id&&s.set(Number(t.id),e)}),s}),V=f(()=>(D.value||[]).filter(s=>String(s?.membership?.role||s?.UserDepartment?.role||s?.user_department?.role||"").toLowerCase()==="supervisor")),Y=f(()=>p.value||(D.value||[]).some(s=>String(s?.membership?.role||"").toLowerCase()==="supervisor")),j=s=>p.value?!0:W.value.get(Number(s?.department_id))==="supervisor",H=[{key:"description",label:"Description",sortable:!1,minWidth:280},{key:"area",label:"Area",sortable:!0,width:140},{key:"type",label:"Type",sortable:!0,width:140},{key:"department",label:"Department",sortable:!1,minWidth:200},{key:"is_active",label:"Active",sortable:!0,width:90}],J=s=>C.departments?.data?.find(e=>e.id===s)?.name||`#${s}`,T=A(!1),b=A("create"),r=A({id:null,description:"",area:"Governance",type:"core",is_active:!0,department_id:""}),y=A({}),K=()=>{b.value="create";const s=V.value?.[0],t=C.departments?.data?.[0],e=p.value?t?.id||"":s?.id||"";r.value={id:null,description:"",area:"Governance",type:"core",is_active:!0,department_id:e},y.value={},T.value=!0},X=async s=>{try{await o.fetchById(s.id);const t=o.selected||s;b.value="edit",r.value={id:t.id,description:t.description||"",area:t.area||"Governance",type:t.type||"core",is_active:!!t.is_active,department_id:t.department_id||""},y.value={},T.value=!0}catch{}},Z=()=>{const s={};return r.value.description?.trim()||(s.description="Description is required"),b.value==="create"&&!r.value.department_id&&(s.department_id="Department is required"),y.value=s,Object.keys(s).length===0},ee=async()=>{if(!Z())return;const s={description:r.value.description.trim(),area:(r.value.area||"").trim(),type:(r.value.type||"").trim()||null,is_active:!!r.value.is_active,department_id:Number(r.value.department_id||0)||void 0};b.value==="create"?await o.create(s):await o.updateById(r.value.id,s),T.value=!1,await _({},!0)},te=async s=>{!s?.id||!(await z.fire({title:"Delete standard?",text:"This action cannot be undone.",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Delete"})).isConfirmed||(await o.deleteById(s.id),await _({},!0),await z.fire("Deleted","Standard removed.","success"))},G=f({get:()=>r.value.area||"",set:s=>{r.value.area=s}});return(s,t)=>(l(),x(ie,null,{default:u(()=>[k(ne,null,{default:u(()=>[R.value==="member"?(l(),x($,{key:0,color:"info",class:"mb-3"},{default:u(()=>[...t[12]||(t[12]=[g(" You are viewing member mode — actions may be limited. ",-1)])]),_:1})):R.value==="supervisor"?(l(),x($,{key:1,color:"info",class:"mb-3"},{default:u(()=>[...t[13]||(t[13]=[g(" You are viewing supervisor mode — department-wide standards. ",-1)])]),_:1})):c("",!0),k(me,{icon:v(oe),title:"Standards",main:""},{default:u(()=>[...t[14]||(t[14]=[g(" Manage standards and assignments ",-1)])]),_:1},8,["icon"]),a("div",be,[a("div",ye,[Y.value?(l(),x(B,{key:0,icon:v(de),color:"primary",label:"New Standard",onClick:K},null,8,["icon"])):c("",!0)]),a("div",xe,[k(B,{icon:v(ue),color:"info",label:"Refresh",onClick:t[0]||(t[0]=()=>_({},!0))},null,8,["icon"])])]),v(o).error?(l(),x($,{key:2,color:"danger"},{default:u(()=>[g(d(v(o).error),1)]),_:1})):c("",!0),a("div",ke,[a("div",we,[a("div",null,[t[15]||(t[15]=a("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"Description",-1)),w(a("input",{"onUpdate:modelValue":t[1]||(t[1]=e=>n.value.description=e),class:"w-full border p-2 rounded",placeholder:"Search..."},null,512),[[P,n.value.description]])]),a("div",null,[t[16]||(t[16]=a("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"Area",-1)),w(a("input",{list:"areas","onUpdate:modelValue":t[2]||(t[2]=e=>n.value.area=e),class:"w-full border p-2 rounded",placeholder:"Area"},null,512),[[P,n.value.area]]),a("datalist",he,[(l(),i(h,null,S(I,e=>a("option",{key:e,value:e},null,8,Se)),64))])]),a("div",null,[t[17]||(t[17]=a("label",{class:"block text-xs font-medium text-gray-600 mb-1"},"Department",-1)),w(a("select",{"onUpdate:modelValue":t[3]||(t[3]=e=>n.value.department_id=e),class:"w-full border p-2 rounded"},[p.value?(l(),i("option",Ce,"All")):c("",!0),p.value?(l(!0),i(h,{key:1},S(v(C).departments.data,e=>(l(),i("option",{key:e.id,value:e.id},d(e.name),9,De))),128)):(l(!0),i(h,{key:2},S(V.value,e=>(l(),i("option",{key:"supervised-"+e.id,value:e.id},d(e.name),9,Ae))),128))],512),[[M,n.value.department_id]])])])]),k(ve,{columns:H,data:Q.value,loading:v(o).isLoading,onQueryChange:t[4]||(t[4]=e=>_(e,!0))},{"cell-description":u(({row:e})=>[a("div",Ne,d(e.description),1)]),"cell-area":u(({row:e})=>[a("span",Be,d(e.area||"-"),1)]),"cell-type":u(({row:e})=>[a("span",Te,d(e.type||"-"),1)]),"cell-department":u(({row:e})=>[a("div",Ue,d(e.department_id?J(e.department_id):"-"),1)]),"cell-is_active":u(({row:e})=>[a("span",{class:N(["inline-flex items-center gap-1 px-2 py-[2px] rounded-full text-[11px] ring-1",e.is_active?"bg-emerald-50 text-emerald-700 ring-emerald-200":"bg-rose-50 text-rose-700 ring-rose-200"])},[a("span",{class:N(["inline-block h-2 w-2 rounded-full",e.is_active?"bg-emerald-500":"bg-rose-500"])},null,2),g(" "+d(e.is_active?"Active":"Inactive"),1)],2)]),"cell-actions":u(({row:e})=>[a("div",Ve,[j(e)?(l(),x(B,{key:0,icon:v(ce),small:"",color:"secondary",outline:"",onClick:m=>X(e)},null,8,["icon","onClick"])):c("",!0),j(e)?(l(),x(B,{key:1,icon:v(pe),small:"",color:"danger",outline:"",onClick:m=>te(e)},null,8,["icon","onClick"])):c("",!0)])]),_:1},8,["data","loading"]),k(le,{name:"fade"},{default:u(()=>[T.value?(l(),i("div",Pe,[a("div",Ee,[a("div",Ie,[a("h3",Le,d(b.value==="create"?"Create Standard":"Edit Standard"),1),k(B,{label:"Close",color:"secondary",outline:"",small:"",onClick:t[5]||(t[5]=e=>T.value=!1)})]),a("div",Me,[b.value==="create"?(l(),i("div",$e,[t[19]||(t[19]=a("label",{class:"block text-sm mb-1"},[g("Department "),a("span",{class:"text-red-500"},"*")],-1)),w(a("select",{"onUpdate:modelValue":t[6]||(t[6]=e=>r.value.department_id=e),class:"w-full border p-2 rounded"},[t[18]||(t[18]=a("option",{value:"",disabled:""},"Select department",-1)),p.value?(l(!0),i(h,{key:0},S(v(C).departments.data,e=>(l(),i("option",{key:e.id,value:e.id},d(e.name),9,Re))),128)):(l(!0),i(h,{key:1},S(V.value,e=>(l(),i("option",{key:"supervised-"+e.id,value:e.id},d(e.name),9,je))),128))],512),[[M,r.value.department_id]]),y.value.department_id?(l(),i("div",Ge,d(y.value.department_id),1)):c("",!0)])):c("",!0),a("div",null,[t[20]||(t[20]=a("label",{class:"block text-sm mb-1"},[g("Description "),a("span",{class:"text-red-500"},"*")],-1)),w(a("textarea",{"onUpdate:modelValue":t[7]||(t[7]=e=>r.value.description=e),rows:"3",class:"w-full border p-2 rounded",placeholder:"Describe the standard..."},null,512),[[P,r.value.description]]),y.value.description?(l(),i("div",ze,d(y.value.description),1)):c("",!0)]),a("div",qe,[a("div",null,[t[21]||(t[21]=a("label",{class:"block text-sm mb-1"},"Area",-1)),w(a("input",{list:"areas-edit","onUpdate:modelValue":t[8]||(t[8]=e=>G.value=e),class:"w-full border p-2 rounded",placeholder:"e.g., Governance"},null,512),[[P,G.value]]),a("datalist",Fe,[(l(),i(h,null,S(I,e=>a("option",{key:e,value:e},null,8,Oe)),64))]),t[22]||(t[22]=a("div",{class:"text-[11px] text-gray-500 mt-1"},"Defaults provided; new area names allowed.",-1))]),a("div",null,[t[23]||(t[23]=a("label",{class:"block text-sm mb-1"},"Type",-1)),w(a("select",{"onUpdate:modelValue":t[9]||(t[9]=e=>r.value.type=e),class:"w-full border p-2 rounded"},[(l(),i(h,null,S(O,e=>a("option",{key:e.value,value:e.value},d(e.label),9,Qe)),64))],512),[[M,r.value.type]])]),a("div",We,[a("div",Ye,[a("label",He,[a("input",{type:"radio",name:"is_active",checked:!!r.value.is_active,onChange:t[10]||(t[10]=e=>r.value.is_active=!0),class:"hidden"},null,40,Je),a("span",{class:N(["inline-flex items-center gap-1 px-2 py-[2px] rounded-full text-[12px] ring-1",r.value.is_active?"bg-emerald-50 text-emerald-700 ring-emerald-200":"bg-gray-50 text-gray-500 ring-gray-200"])},[a("span",{class:N(["inline-block h-2 w-2 rounded-full",r.value.is_active?"bg-emerald-500":"bg-gray-400"])},null,2),t[24]||(t[24]=g(" Active ",-1))],2)]),a("label",Ke,[a("input",{type:"radio",name:"is_active",checked:!r.value.is_active,onChange:t[11]||(t[11]=e=>r.value.is_active=!1),class:"hidden"},null,40,Xe),a("span",{class:N(["inline-flex items-center gap-1 px-2 py-[2px] rounded-full text-[12px] ring-1",r.value.is_active?"bg-gray-50 text-gray-500 ring-gray-200":"bg-rose-50 text-rose-700 ring-rose-200"])},[a("span",{class:N(["inline-block h-2 w-2 rounded-full",r.value.is_active?"bg-gray-400":"bg-rose-500"])},null,2),t[25]||(t[25]=g(" Inactive ",-1))],2)])])])]),a("div",Ze,[k(B,{color:"primary",label:b.value==="create"?"Create":"Save Changes",onClick:ee},null,8,["label"])]),I.includes(String(r.value.area||"").trim())?c("",!0):(l(),i("div",et," Note: Backend may restrict areas to defaults; new areas might require server updates. "))])])])):c("",!0)]),_:1})]),_:1})]),_:1}))}},vt=_e(tt,[["__scopeId","data-v-75f26784"]]);export{vt as default};
